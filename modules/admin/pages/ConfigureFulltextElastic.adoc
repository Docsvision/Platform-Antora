= Подключение полнотекстового поиска Elasticsearch

[NOTE]
====
[.note__title]#Important:# Лицензия {dv} должна содержать опцию "{dv} Внешний полнотекстовый поиск ElasticSearch", иначе использование полнотекстового поиска, реализуемого ElasticSearch, приведет к ошибке сервера {dv}.
====

. xref:installElasticSearch.adoc[Установите систему полнотекстового поиска ElasticSearch].
. Откройте _{cns}_.
. Перейдите к элементу *модули расширения* > *Сервис полнотекстового поиска*#.
. Нажмите кнопку *Добавить базу данных*. Будет открыто окно добавления БД к сервису полнотекстового индексирования.
+
Для корректного поиска по базе данных Microsoft SQL в настройках индексации необходимо добавить локаль отличную от нейтральной, например, русский язык.
+
image::AddDbToFulltextStartPage.png[Окно добавления БД к сервису полнотекстового индексирования]
. В списке *Название базы* выберите подключаемую БД {dv}, установите флаг *Использовать внешний полнотекстовый поиск (Elasticsearch)*. Нажмите *Далее* для продолжения настройки.
+
В списке баз данных отображаются БД, xref:serverConsoleDataBases.adoc[подключенные] к данному серверу {dv}.
. Настройте параметры подключения БД к системе полнотекстового поиска.
+
image::AddDbToElasticConfig.png[Окно параметров подключения БД к системе полнотекстового поиска]
[loweralpha]
.. В поле *Elasticsearch url* укажите адрес системы Elasticsearch.
+
Адрес имеет следующий вид:

[source]
----
http://elastic.company.com:9200
----
.. Поле *Строка подключения к базе* содержит неизменяемую строку подключения к БД, которая подключается к сервису полнотекстового индексирования.
.. В поле *Сервер DocsVision* должна быть указана строка подключения к службе сервера {dv}.
+
Строка подключения имеет следующий вид:

[source]
----
ConnectAddress=http://company.com/DocsVision/StorageServer/StorageServerService.asmx
----
+
По умолчанию в поле отображается строка подключения к текущему серверу {dv}.
.. Нажмите кнопку *Тест соединений*. Будет выполнена проверка подключения к системе Elasticsearch и серверу {dv}. Строка подключения будет выделена красным, если подключение не удалось (проверьте корректность параметров).
.. Нажмите кнопку *Далее*.
+
Если введены неверные данные, кнопка *Далее* будет заблокирована. Исправьте настройки и повторите п. 4.
. В следующем окне настройте параметры индексирования карточек.
+
image::AddDbToElasticConfigCards.png[Окно настройки параметров индексирования карточек]
[loweralpha]
.. Установите флажок индексирования у отдельных полей карточек. Типы карточек выбранных полей будут добавлены в список *Индексируемые карточки.*#
+
*Не выбирайте целиком типы карточек или секции карточек. Выбирайте только поля текстовых типов*.
+
Поля, выделенные серым цветом, не могут быть выбраны.
.. Если требуется, измените количество https://www.elastic.co/guide/en/elasticsearch/reference/5.5/_basic_concepts.html#getting-started-shards-and-replicas[шардов] (shards) в индексе. Для этого выберите +++тип+++ карточек в списке типов, и измените значение в поле *Количество фрагментов индекса*.
+
Для каждого типа карточек создается отдельный индекс, количество фрагментов в котором регулируется указанной настройкой.
.. Если требуется, включите анализатор текста для полей карточек. Для этого выберите поле карточки в списке карточек, и установите флаг *Анализировать поле*.
+
Анализатор -- дополнительный компонент Elasticsearch, используемый для формирования полнотекстовых индексов с учетом морфологии языка.
+
Также при выборе поля карточки, справа отобразится информация о поле:

* *Тип поля*;
* *Доступно для индексирования* -- по полю может быть выполнен поиск.
.. Установите флаг "Удалять первичные данные файлов после обработки", чтобы индексируемые файлы, по которым были сформированы данные для поиска, автоматически удалялись из базы Elasticsearch.
+
В Elasticsearch существует два набора данных:

* RawContent -- исходные данные файлов, переданные из {dv}. Исходные данные не используются в поиске -- по ним формируются обработанные данные (CleanContent).
* CleanContent -- обработанные данные, сформированные из RawContent. Обработанные данные используются в полнотекстовом поиске.
+
При включенной настройке "Удалять первичные данные файлов после обработки" данные RawContent будут автоматически удаляться после формирования данных CleanContent.
.. Нажмите кнопку *Далее*.
. В следующем окне настройте параметры индексирования справочников.
+
image::AddDbToElasticConfigDictionaries.png[Окно настройки параметров индексирования справочников]
[loweralpha]
.. Установите флажок индексирования у отдельных полей справочников.
+
*Не выбирайте целиком библиотеки карточек или справочники. Выбирайте только поля текстовых типов.*
+
Поля, выделенные серым цветом, не могут быть выбраны.
+
[NOTE]
====
[.note__title]#Note:#

Обратите внимание, что для поля, содержащего данные сложного вида, например, _Номер_ необходимо включать настройку *Анализировать поле*. При включенной настройке будет доступен поиск как по части текста (с ограничениями), так и по полному совпадению. Если анализатор не выключен, будет срабатывать нечёткий поиск.
====

image::elasticIndexing.png[Особенности индексирования данных сложного вида]
.. Нажмите кнопку *Далее*.
. Нажмите *Завершить*, чтобы подключить БД к сервису полнотекстового индексирования с текущими настройками. База данных будут добавлена в список баз данных, использующих сервис полнотекстового индексирования.
. Включите индексирование добавленной базы данных.
[loweralpha]
.. Выберите добавленную базу данных в списке и нажмите кнопку *Свойства индексирования*. Будет открыто окно настройки индексирования БД.
+
image::AddDbToFulltextIndexingElasticEnable.png[Общие настройки индексирования баз данных]
.. Установите переключатель *Статус индексирования* в значение "Включено".
.. Нажмите кнопку *Применить* для сохранения изменений.
+
В списке индексируемых БД, у настраиваемой БД значение в колонке "Индексирование" изменится на "Да".
. Если в Elasticsearch специальным образом настроена безопасность, предоставьте учетной записи сервиса полнотекстового индексирования полный доступ к Elasticsearch.
. Перезапустите сервер {dv} (пул приложений "DocsVision" или IIS) и сервис полнотекстового индексирования (службу "{dv} 5.5 Full-text indexing Service").

Чтобы убедиться, что индексирование с Elasticsearch работает, перейдите (подождать 5 минут после выполнения шага 12) по адресу `http://elastic.company.com:9200/_search?filter_path=hits.total`. В поле `total` должно отображаться число больше нуля.
