[[ariaid-title1]]
== Подключение полнотекстового поиска Elasticsearch

[NOTE]
====
[.note__title]#Important:# Лицензия Docsvision должна содержать опцию «Docsvision Внешний полнотекстовый поиск ElasticSearch», иначе использование полнотекстового поиска, реализуемого ElasticSearch, приведет к ошибке сервера Docsvision.
====

. [.ph .cmd]#xref:InstallElasticsearch.adoc[Установите систему полнотекстового поиска ElasticSearch].#
. [.ph .cmd]#Откройте Консоль настройки Docsvision.#
. [.ph .cmd]#Перейдите к элементу [.ph .menucascade]#[.ph .uicontrol]*Модули расширения* > [.ph .uicontrol]*Сервис полнотекстового поиска*#.#
. [.ph .cmd]#Нажмите кнопку [.ph .uicontrol]*Добавить базу данных*. Будет открыто окно добавления БД к сервису полнотекстового индексирования.#
+
Для корректного поиска по базе данных Microsoft SQL в настройках индексации необходимо добавить локаль отличную от нейтральной, например, русский язык.
+
image::img/AddDbToFulltextStartPage.png[[.fig--title-label]##Figure 1. ##Окно добавления БД к сервису полнотекстового индексирования]
. [.ph .cmd]#В списке [.ph .uicontrol]*Название базы* выберите подключаемую БД Docsvision, установите флаг [.ph .uicontrol]*Использовать внешний полнотекстовый поиск (Elasticsearch)*. Нажмите [.ph .uicontrol]*Далее* для продолжения настройки.#
+
В списке баз данных отображаются БД, xref:Server_Settings_Databases.adoc[подключенные] к данному серверу Docsvision.
. [.ph .cmd]#Настройте параметры подключения БД к системе полнотекстового поиска.#
+
image::img/AddDbToElasticConfig.png[[.fig--title-label]##Figure 2. ##Окно параметров подключения БД к системе полнотекстового поиска]
[loweralpha]
.. [.ph .cmd]#В поле [.ph .uicontrol]*Elasticsearch url* укажите адрес системы Elasticsearch.#
+
Адрес имеет следующий вид:

[source,pre,codeblock]
----
http://elastic.company.com:9200
----
.. [.ph .cmd]#Поле [.ph .uicontrol]*Строка подключения к базе* содержит неизменяемую строку подключения к БД, которая подключается к сервису полнотекстового индексирования.#
.. [.ph .cmd]#В поле [.ph .uicontrol]*Сервер DocsVision* должна быть указана строка подключения к службе сервера Docsvision.#
+
Строка подключения имеет следующий вид:

[source,pre,codeblock]
----
ConnectAddress=http://company.com/DocsVision/StorageServer/StorageServerService.asmx
----
+
По умолчанию в поле отображается строка подключения к текущему серверу Docsvision.
.. [.ph .cmd]#Нажмите кнопку [.ph .uicontrol]*Тест соединений*. Будет выполнена проверка подключения к системе Elasticsearch и серверу Docsvision. Строка подключения будет выделена красным, если подключение не удалось (проверьте корректность параметров).#
.. [.ph .cmd]#Нажмите кнопку [.ph .uicontrol]*Далее*.#
+
Если введены неверные данные, кнопка [.ph .uicontrol]*Далее* будет заблокирована. Исправьте настройки и повторите п. 4.
. [.ph .cmd]#В следующем окне настройте параметры индексирования карточек.#
+
image::img/AddDbToElasticConfigCards.png[[.fig--title-label]##Figure 3. ##Окно настройки параметров индексирования карточек]
[loweralpha]
.. [.ph .cmd]#Установите флажок индексирования у отдельных полей карточек. Типы карточек выбранных полей будут добавлены в список [.ph .uicontrol]*Индексируемые карточки.*#
+
*Не выбирайте целиком типы карточек или секции карточек. Выбирайте только поля текстовых типов*.
+
Поля, выделенные серым цветом, не могут быть выбраны.
.. [.ph .cmd]#Если требуется, измените количество https://www.elastic.co/guide/en/elasticsearch/reference/5.5/_basic_concepts.html#getting-started-shards-and-replicas[шардов] (shards) в индексе. Для этого выберите +++тип+++ карточек в списке типов, и измените значение в поле [.ph .uicontrol]*Количество фрагментов индекса*.#
+
Для каждого типа карточек создается отдельный индекс, количество фрагментов в котором регулируется указанной настройкой.
.. [.ph .cmd]#Если требуется, включите анализатор текста для полей карточек. Для этого выберите поле карточки в списке карточек, и установите флаг [.ph .uicontrol]*Анализировать поле*.#
+
Анализатор – дополнительный компонент Elasticsearch, используемый для формирования полнотекстовых индексов с учетом морфологии языка.
+
Также при выборе поля карточки, справа отобразится информация о поле:

* [.ph .uicontrol]*Тип поля*;
* [.ph .uicontrol]*Доступно для индексирования* – по полю может быть выполнен поиск.
.. [.ph .cmd]#Установите флаг «Удалять первичные данные файлов после обработки», чтобы индексируемые файлы, по которым были сформированы данные для поиска, автоматически удалялись из базы Elasticsearch.#
+
В Elasticsearch существует два набора данных:

* RawContent – исходные данные файлов, переданные из Docsvision. Исходные данные не используются в поиске – по ним формируются обработанные данные (CleanContent).
* CleanContent – обработанные данные, сформированные из RawContent. Обработанные данные используются в полнотекстовом поиске.
+
При включенной настройке «Удалять первичные данные файлов после обработки» данные RawContent будут автоматически удаляться после формирования данных CleanContent.
.. [.ph .cmd]#Нажмите кнопку [.ph .uicontrol]*Далее*.#
. [.ph .cmd]#В следующем окне настройте параметры индексирования справочников.#
+
image::img/AddDbToElasticConfigDictionaries.png[[.fig--title-label]##Figure 4. ##Окно настройки параметров индексирования справочников]
[loweralpha]
.. [.ph .cmd]#Установите флажок индексирования у отдельных полей справочников.#
+
*Не выбирайте целиком библиотеки карточек или справочники. Выбирайте только поля текстовых типов.*
+
Поля, выделенные серым цветом, не могут быть выбраны.
+
[NOTE]
====
[.note__title]#Note:#

Обратите внимание, что для поля, содержащего данные сложного вида, например, [.dfn .term]_Номер_ необходимо включать настройку [.keyword .wintitle]*Анализировать поле*. При включенной настройке будет доступен поиск как по части текста (с ограничениями), так и по полному совпадению. Если анализатор не выключен, будет срабатывать нечёткий поиск.
====

image::img/elasticIndexing.png[[.fig--title-label]##Figure 5. ##Особенности индексирования данных сложного вида]
.. [.ph .cmd]#Нажмите кнопку [.ph .uicontrol]*Далее*.#
. [.ph .cmd]#Нажмите [.ph .uicontrol]*Завершить*, чтобы подключить БД к сервису полнотекстового индексирования с текущими настройками. База данных будут добавлена в список баз данных, использующих сервис полнотекстового индексирования.#
. [.ph .cmd]#Включите индексирование добавленной базы данных.#
[loweralpha]
.. [.ph .cmd]#Выберите добавленную базу данных в списке и нажмите кнопку [.ph .uicontrol]*Свойства индексирования*. Будет открыто окно настройки индексирования БД.#
+
image::img/AddDbToFulltextIndexingElasticEnable.png[[.fig--title-label]##Figure 6. ##Общие настройки индексирования баз данных]
.. [.ph .cmd]#Установите переключатель [.ph .uicontrol]*Статус индексирования* в значение «Включено».#
.. [.ph .cmd]#Нажмите кнопку [.ph .uicontrol]*Применить* для сохранения изменений.#
+
В списке индексируемых БД, у настраиваемой БД значение в колонке «Индексирование» изменится на «Да».
. [.ph .cmd]#Если в Elasticsearch специальным образом настроена безопасность, предоставьте учетной записи сервиса полнотекстового индексирования полный доступ к Elasticsearch.#
. [.ph .cmd]#Перезапустите сервер Docsvision (пул приложений «DocsVision» или IIS) и сервис полнотекстового индексирования (службу «Docsvision 5.5 Full-text indexing Service»).#

Чтобы убедиться, что индексирование с Elasticsearch работает, перейдите (подождать 5 минут после выполнения шага 12) по адресу [.ph .filepath]`http://elastic.company.com:9200/_search?filter_path=hits.total`. В поле `total` должно отображаться число больше нуля.

*Parent topic:* xref:../topics/Preparing_to_Work_Configure_FullText_Search.adoc[Настройка полнотекстового поиска]
