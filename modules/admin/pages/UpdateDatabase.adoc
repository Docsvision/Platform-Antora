= Обновление базы данных

Версия базы данных {dv} должна соответствовать версии сервера {dv}. Чтобы обновить БД до версии сервера, выполните следующие действия.

[NOTE]
====
[.note__title]#Прим.:# При обновлении БД {dv} индексы, добавленные самостоятельно, будут удалены.
====

[[task_jxb_2gm_fp__steps_cgn_4fm_fp]]
. Откройте xref:DatabasesMaster.adoc[мастер БД {dv}].
+
image::DatabaseMaster.png[Мастер БД {dv}]
. Выберите в списке обновляемую базу данных.
. Выберите режим "Обновить выбранную в списке базу данных". Нажмите *Далее*.
. Выберите библиотеки карточек, которые должны быть обновлены. Нажмите *Далее*.
+
image::updateDBCardLibs.png[Выбор обновляемых библиотек карточек]
+
Библиотеки карточек, версии которых отличаются от установленных в БД версий, будут автоматически выбраны (данные библиотеки могут быть обновлены). Если версия загружаемой библиотеки карточек соответствует версии библиотеки в БД или файлы библиотеки карточек отсутствуют в каталоге сервера {dv} (`C:\Program Files (x86)\{dv}\Platform\5.5\Tools\Database`), возможность выбора таких библиотек карточек будет заблокирована (строчки серого цвета), флаг -- снят.
+
В строке "Пользовательские метаданные" указано была ли модифицирована (добавлены пользовательские метаданные) установленная в БД библиотека карточек.
+
В строке с режимом обновления БД указывается выбранный платформой {dv} вариант обновления БД:

* "полный режим" -- будет выполнено полное обновление выбранных библиотек карточек и версии клиентских компонентов;
* "лёгкий режим" -- будет обновлена только информация о версии клиентских компонентов.
+
Если для обновления выбрано несколько библиотек карточек и одна из них требует полного обновления, то в строке с режимом обновления будет указано "База данных будет обновлена в полном режиме". При этом каждая библиотека обновляется в требуемом ей режиме (лёгком или полном).
+
[NOTE]
====
[.note__title]#Прим.:# Принцип определения требуемого режима обновления:

* если изменилась версия генератора схем карточек -- все библиотеки карточек будут обновлены в полном режиме;
* если изменилась схема библиотеки карточек, но не изменилась схема её карточек -- будут установлены/обновлены только расширенные отчёты и скрипты данной библиотеки карточек;
* если изменилась схема одной или нескольких карточек библиотеки карточек -- библиотека карточек будет обновлена полностью;
* если изменений генератора, схемы библиотеки карточек и схем карточек не было -- обновление будет выполнено в лёгком режиме.
====
. Подтвердите настройки, которые будут использованы для обновления базы данных. Нажмите *Далее*.
+
image::DatabaseUpdate_1.png[Мастер БД {dv} в режиме создания базы данных]
+
Значение *Ожидать завершения атомарной операции на SQL Server (сек)* определяет максимальное время ожидания завершения отдельного этапа (операции) процедуры создания/подключения БД. Если операция не будет выполнена за указанное время, она завершится с ошибкой.

[NOTE]
====
[.note__title]#Прим.:# Параметр *Ожидать завершения атомарной операции на SQL Server (сек)* не ограничивает время выполнения пользовательских операций (при работе в {wincl}е) -- будет применяться стандартное ограничение 600 секунд.
====
. Утвердительно ответьте на запрос об обновлении БД. Дождитесь завершения обновления БД и загрузки SQL объектов.
+
[NOTE]
====
[.note__title]#Важное замечание:# Обновление базы данных может занять продолжительное время. Пользователи и сервисы, использующие эту базу данных, будут отключены, и не смогут подключаться к ней до окончания процесса обновления.
====
+
Если процесс обновления базы данных был прерван по таймауту, увеличьте значение настройки `Ожидать завершения атомарной операции на SQL Server (сек)` и повторите процедуру обновления.
. Выберите модули {dv}, настройки которых должны быть обновлены в БД, и нажмите кнопку *Завершить*. При этом существующие в БД стандартные настройки выбранных модулей будут перезаписаны.
+
image::DatabaseCreate_5.png[Выбор модулей, настройки которых будут загружены в БД]
+
Возможность выбора модулей, настройки которых не нуждаются в обновлении (версия в БД является актуальной), будет заблокирована.

image::DatabaseCreate_5WithDisabled.png[Список модулей с актуальной версией настроек модуля "Почтовый клиент"]
. Дождитесь завершения загрузки настроек.
. Перезапустите сервисы {dv} для применения новых параметров.
+
image::configMasterReload.png[Запрос на перезапуск сервисов {dv}]

Чтобы вернуть базу данных в рабочее состояние, нужно:

. Включить полнотекстовый поиск (перед обновлением поиск автоматически отключается).
. Пересоздать все индексы, которые были добавлены при внедрении системы.
. Если в базу данных при внедрении системы были добавлены триггеры, то после обновления базы данных их потребуется создать повторно.

