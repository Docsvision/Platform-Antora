= Настройка группы доступности AlwaysOn

Требования для использования AlwaysOn:

* Отказоустойчивый кластер Windows (https://docs.microsoft.com/ru-ru/sql/sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server[WSFC]) – MS SQL Server AlwayOn настраивается в кластере Windows, при этом экземпляры SQL Server могут быть без кластеризации;
* Microsoft SQL Server 2014 или выше *с редакцией Enterprise Edition* – должен быть установлен на каждом узле кластера.
* Наличие Active Directory.

[NOTE]
====
Полный список требований приведен на странице https://docs.microsoft.com/ru-ru/sql/database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability?view=sql-server-2017#PrerequisitesSI.
====

Для настройки группы доступности:

. Создайте отказоустойчивый кластер Windows Server. В кластер должен быть включен узел с установленным Microsoft SQL Server с БД {dv}.
+
[NOTE]
====
Инструкция по настройке кластера Windows Server в первой части статьи https://social.technet.microsoft.com/wiki/contents/articles/36143.sql-server-2016-step-by-step-creating-alwayson-availability-group.aspx#Enable_AlwaysOn_Availability_Groups_Feature_on_SQL_Server_2016[SQL Server 2016 Step by Step: Creating AlwaysOn Availability Group].
====
. Установите Microsoft SQL Server на другие узлы кластера.
+
*Обратите внимание*:

* У всех экземпляров Microsoft SQL Server должны быть настроены одинаковые параметры сортировки SQL Server (Collation).
* Если используется FILESTREAM, то он должен быть включен на каждом сервере SQL, который планируется включить в группу доступности.
* При установке нужно указать доменную учётную запись для запуска службы Microsoft SQL Server (можно настроить после установки). Данная учётная запись должна быть включена в локальную группу безопасности "Администраторы". Рекомендуется для всех узлов указывать одну учётную запись (https://docs.microsoft.com/ru-ru/sql/database-engine/database-mirroring/set-up-login-accounts-database-mirroring-always-on-availability?view=sql-server-2017).
. На всех узлах:
[loweralpha]
.. В настройках брандмауэра разрешите подключения на порт 5022 (требуется для работы AlwaysOn).
.. В настройках Microsoft SQL Server включите использование протоколов Shared Memory, Named Pipes и TCP/IP.
+
image::sqlserverconfmanager.png[Настройки протоколов в конфигурации Microsoft SQL Server]
.. Убедитесь, что в настройках службы SQL Server (в SQL Server Configuration Manager), в т.ч. и на основном сервере, указана (одна – рекомендуется) *доменная учётная запись* для запуска службы. Если указана локальная учетная запись – измените. Учётная запись должна быть включена в локальную группу безопасности "Администраторы". У учётных записей должен быть доступ к SQL Server других узлов – обычно обеспечивается использованием общей доменной записи для всех экземпляров SQL Server.
+
image::sqlserverconfmanagerlogon.png[Настройки службы SQL Server]
. На всех узлах в настройках службы Microsoft SQL Server (в SQL Server Configuration Manager) включите поддержку AlwaysOn.
+
image::enableAlwaysOn.png[Настройка поддержки AlwaysOn в конфигурации службы Microsoft SQL Server]
. Создайте полную резервную копию БД {dv} (и сателлитных БД, если используются).
. Создайте группу доступности AlwaysOn с помощью Microsoft SQL Server Management Studio на основном сервере Microsoft SQL:#
[loweralpha]
.. Вызовите команду *New Availability Group Wizard* из контекстного меню узла "Always On High Availability".
+
image::createAlwaysOnCommand.png[Команда создания группы доступности]

Будет запущен мастер.

image::aoMaster.png[Мастер создания группы доступности]
.. На странице "Specify Options" укажите название группы. Например, "{dv}DBs". Другие параметры изменять не требуется.
+
image::aoMasterGroupName.png[Мастер создания группы доступности]
.. На странице "Select Databases" выберите БД {dv}, которые нужно включить в группу доступности.
+
Если архивные данные, системные данные и/или журналы вытеснены из базы данных {dv}, рекомендуется данные БД также включить в группу доступности. Внешние (сателлитные) БД имеют названия: "[Название БД {dv}]_Archive" (для архивных данных), "[Название БД {dv}]_Metadata" (для системных данных), "[Название БД {dv}]_Log" (для журналов работы).

image::aoMasterDb.png[Мастер создания группы доступности]
.. На странице "Specify Replicas" настройте параметры реплик.
+
[lowerroman]
... Добавьте сервера Microsoft SQL, на которых будут располагаться реплики. Для этого нажмите кнопку *Add Replica...* и укажите параметры подключения к серверу.
... Для всех экземпляров серверов:
.... Установите флажок *Automatic Failover (Up to 3).*
.... *Availability Mode* переключите в "Synchronous commit".
.... *Readable Secondary* переключите в "Yes".
+
image::aoMasterGroupReplicas.png[Мастер создания группы доступности]
+
Настраивать "слушателя" (страница *Listener*) не требуется.
.. На странице *Select Data Synchronization* оставьте переключатель в значении *Automatic seeding* (доступность варианта зависит от версии Microsoft SQL Server).
+
image::aoMasterGroupSyncType.png[Мастер создания группы доступности]
.. При переходе на страницу *Validation* будет выполнена проверка создания группы доступности.
+
image::aoMasterGroupValidation.png[Мастер создания группы доступности]
+
Предупреждение, касающееся "слушателя", можно игнорировать.
.. На странице *Summary* нажмите *Finish* для выполнения создания группы доступности.
.. Завершите работу с мастером.
+
Состояние группы доступности можно посмотреть на панели мониторинга:

image::aoMasterGroupState.png[Панель мониторинга группы доступности]

[NOTE]
====
Дополнительная информация по настройке группы доступности AlwaysOn приведена на странице https://social.technet.microsoft.com/wiki/contents/articles/36143.sql-server-2016-step-by-step-creating-alwayson-availability-group.aspx#Enable_AlwaysOn_Availability_Groups_Feature_on_SQL_Server_2016.
====

