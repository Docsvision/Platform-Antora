[[ariaid-title1]]
== Настройка группы доступности AlwaysOn

Требования для использования AlwaysOn:

* Отказоустойчивый кластер Windows (https://docs.microsoft.com/ru-ru/sql/sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server[WSFC]) – MS SQL Server AlwayOn настраивается в кластере Windows, при этом экземпляры SQL Server могут быть без кластеризации;
* Microsoft SQL Server 2014 или выше *с редакцией Enterprise Edition* – должен быть установлен на каждом узле кластера.
* Наличие Active Directory.

[NOTE]
====
[.note__title]#Note:# Полный список требований приведен на странице https://docs.microsoft.com/ru-ru/sql/database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability?view=sql-server-2017#PrerequisitesSI.
====

Для настройки группы доступности:

. [.ph .cmd]#Создайте отказоустойчивый кластер Windows Server. В кластер должен быть включен узел с установленным Microsoft SQL Server с БД Docsvision.#
+
[NOTE]
====
[.note__title]#Note:# Инструкция по настройке кластера Windows Server в первой части статьи https://social.technet.microsoft.com/wiki/contents/articles/36143.sql-server-2016-step-by-step-creating-alwayson-availability-group.aspx#Enable_AlwaysOn_Availability_Groups_Feature_on_SQL_Server_2016[SQL Server 2016 Step by Step: Creating AlwaysOn Availability Group].
====
. [.ph .cmd]#Установите Microsoft SQL Server на другие узлы кластера.#
+
*Обратите внимание*:

* У всех экземпляров Microsoft SQL Server должны быть настроены одинаковые параметры сортировки SQL Server (Collation).
* Если используется FILESTREAM, то он должен быть включен на каждом сервере SQL, который планируется включить в группу доступности.
* При установке нужно указать доменную учётную запись для запуска службы Microsoft SQL Server (можно настроить после установки). Данная учётная запись должна быть включена в локальную группу безопасности «Администраторы». Рекомендуется для всех узлов указывать одну учётную запись (https://docs.microsoft.com/ru-ru/sql/database-engine/database-mirroring/set-up-login-accounts-database-mirroring-always-on-availability?view=sql-server-2017).
. [.ph .cmd]#На всех узлах:#
[loweralpha]
.. [.ph .cmd]#В настройках брандмауэра разрешите подключения на порт 5022 (требуется для работы AlwaysOn).#
.. [.ph .cmd]#В настройках Microsoft SQL Server включите использование протоколов Shared Memory, Named Pipes и TCP/IP.#
+
image::img/sqlserverconfmanager.png[[.fig--title-label]##Figure 1. ##Настройки протоколов в конфигурации Microsoft SQL Server]
.. [.ph .cmd]#Убедитесь, что в настройках службы SQL Server (в SQL Server Configuration Manager), в т.ч. и на основном сервере, указана (одна – рекомендуется) *доменная учётная запись* для запуска службы. Если указана локальная учетная запись – измените. Учётная запись должна быть включена в локальную группу безопасности «Администраторы». У учётных записей должен быть доступ к SQL Server других узлов – обычно обеспечивается использованием общей доменной записи для всех экземпляров SQL Server.#
+
image::img/sqlserverconfmanagerlogon.png[[.fig--title-label]##Figure 2. ##Настройки службы SQL Server]
. [.ph .cmd]#На всех узлах в настройках службы Microsoft SQL Server (в SQL Server Configuration Manager) включите поддержку AlwaysOn.#
+
image::img/enableAlwaysOn.png[[.fig--title-label]##Figure 3. ##Настройка поддержки AlwaysOn в конфигурации службы Microsoft SQL Server]
. [.ph .cmd]#Создайте полную резервную копию БД Docsvision (и сателлитных БД, если используются).#
. [.ph .cmd]#Создайте группу доступности AlwaysOn с помощью Microsoft SQL Server Management Studio на основном сервере Microsoft SQL:#
[loweralpha]
.. [.ph .cmd]#Вызовите команду [.ph .uicontrol]*New Availability Group Wizard* из контекстного меню узла «Always On High Availability».#
+
image::img/createAlwaysOnCommand.png[[.fig--title-label]##Figure 4. ##Команда создания группы доступности]

Будет запущен мастер.

image::img/aoMaster.png[[.fig--title-label]##Figure 5. ##Мастер создания группы доступности]
.. [.ph .cmd]#На странице «Specify Options» укажите название группы. Например, «DocsvisionDBs». Другие параметры изменять не требуется.#
+
image::img/aoMasterGroupName.png[[.fig--title-label]##Figure 6. ##Мастер создания группы доступности]
.. [.ph .cmd]#На странице «Select Databases» выберите БД Docsvision, которые нужно включить в группу доступности.#
+
Если архивные данные, системные данные и/или журналы вытеснены из базы данных Docsvision, рекомендуется данные БД также включить в группу доступности. Внешние (сателлитные) БД имеют названия: «[Название БД Docsvision]_Archive» (для архивных данных), «[Название БД Docsvision]_Metadata» (для системных данных), «[Название БД Docsvision]_Log» (для журналов работы).

image::img/aoMasterDb.png[[.fig--title-label]##Figure 7. ##Мастер создания группы доступности]
.. [.ph .cmd]#На странице «Specify Replicas» настройте параметры реплик.#
+
[lowerroman]
... Добавьте сервера Microsoft SQL, на которых будут располагаться реплики. Для этого нажмите кнопку [.ph .uicontrol]*Add Replica...* и укажите параметры подключения к серверу.
... Для всех экземпляров серверов:
.... Установите флажок [.ph .uicontrol]*Automatic Failover (Up to 3).*
.... [.ph .uicontrol]*Availability Mode* переключите в «Synchronous commit».
.... [.ph .uicontrol]*Readable Secondary* переключите в «Yes».
+
image::img/aoMasterGroupReplicas.png[[.fig--title-label]##Figure 8. ##Мастер создания группы доступности]
+
Настраивать «слушателя» (страница [.ph .uicontrol]*Listener*) не требуется.
.. [.ph .cmd]#На странице [.ph .uicontrol]*Select Data Synchronization* оставьте переключатель в значении [.ph .uicontrol]*Automatic seeding* (доступность варианта зависит от версии Microsoft SQL Server).#
+
image::img/aoMasterGroupSyncType.png[[.fig--title-label]##Figure 9. ##Мастер создания группы доступности]
.. [.ph .cmd]#При переходе на страницу [.ph .uicontrol]*Validation* будет выполнена проверка создания группы доступности.#
+
image::img/aoMasterGroupValidation.png[[.fig--title-label]##Figure 10. ##Мастер создания группы доступности]
+
Предупреждение, касающееся «слушателя», можно игнорировать.
.. [.ph .cmd]#На странице [.ph .uicontrol]*Summary* нажмите [.ph .uicontrol]*Finish* для выполнения создания группы доступности.#
.. [.ph .cmd]#Завершите работу с мастером.#
+
Состояние группы доступности можно посмотреть на панели мониторинга:

image::img/aoMasterGroupState.png[[.fig--title-label]##Figure 11. ##Панель мониторинга группы доступности]

[NOTE]
====
[.note__title]#Note:# Дополнительная информация по настройке группы доступности AlwaysOn приведена на странице https://social.technet.microsoft.com/wiki/contents/articles/36143.sql-server-2016-step-by-step-creating-alwayson-availability-group.aspx#Enable_AlwaysOn_Availability_Groups_Feature_on_SQL_Server_2016.
====

*Parent topic:* xref:../topics/AlwaysOn.adoc[Размещение БД Docsvision в группе доступности Microsoft SQL Server AlwaysOn]
