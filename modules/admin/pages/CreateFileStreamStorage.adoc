= Пример. Настройка хранилища файлов в FileStream внешней БД

Далее приведен пример настройки хранилища файлов {dv} в FileStream внешней БД.

. Откройте страницу настроек "Внешние хранилища":#
[loweralpha]
.. Откройте _{cns}_.
.. Перейдите в раздел настроек *Настройки сервера* > *Базы данных*#.
.. Выберите настраиваемую базу данных и нажмите на кнопку *Настройки*. Будет открыто окно *Свойства и управление базой данных*.
.. Откройте вкладку *Внешние хранилища*.
. Подключите к {dv} хранилище FileStream, следуя xref:SetupStorage.adoc[инструкции]. Параметры подключения настройте следующим образом:#
[loweralpha]
.. В поле `Название` введите "StorageInExternalFileStream" или любое другое название.
.. В списке `Тип` выберите значение "FileStream хранилище во внешней базе данных MS SQL".
.. В списке `Состояние` выберите значение "Online".
.. В поле `Макс. размер` оставьте значение по умолчанию (0).
+
После того, как хранилище физически закончится, попытка добавления файла в него завершится ошибкой. Чтобы избежать этого, ограничьте размер хранилища:

[lowerroman]
... В поле `Макс. размер` укажите примерный объем свободного места, который доступен для FileStream.
... В списке `Состояние` выберите значение "Auto".
.. Флаги в блоке `Разделы` установите по собственному усмотрению. Флаг *Временный* рекомендуется снять.
.. В поле `Строка соединения` введите строку формата:#
+
[source]
----
Data Source=ServerName;Initial Catalog=DatabaseName;User ID=UserName;Password=UserPassword;Integrated Security=SSPI
----

где:

* `ServerName` замените на полное имя сервера с СУБД Microsoft SQL;
* `DatabaseName` замените на название базы данных с FileStream;
* `UserName` и `UserPassword` замените на имя и пароль пользователя, который обладает правами на работу с базой данных `DatabaseName`.

Строка подключения должна содержать данные для подключения к внешней БД (по отношению к БД {dv}), в которую будут сохраняться бинарные данные файлов. *Не указывайте текущую или любую другую БД {dv} -- это может привести к поломке БД.*
.. В поле `Папка (локальная на сервере баз данных)` введите полный путь к каталогу на сервере СУБД, на который настроен FileStream.
.. При желании, измените максимальное время ожидания ответа от СУБД в поле `Таймаут (с).`#
+
image::StorageFileStreamConfiguration.png[Пример настройки хранилища во внешнем FileStream]
. Создайте группу хранилищ следуя xref:SetupStorageGroup.adoc[инструкции]. Параметры группы настройте следующим образом:#
[loweralpha]
.. В поле `Название` введите "ExternalFileStreamGroup" или любое другое название.
.. В списке `Режим выбора` оставьте значение по умолчанию.
+
image::StorageFileStreamGroupConfiguration.png[Пример настройки группы хранилищ]

Хранилище можно включить в существующую группу, тогда создавать новую не требуется.
. Включите хранилище "StorageInExternalFileStream" в группу "ExternalFileStreamGroup" следуя xref:AddStorageToStoragesGroup.adoc[инструкции].
. Настройте правила помещения файлов в группу хранилищ "ExternalFileStreamGroup" следуя xref:SetupStorageRule.adoc[инструкции]. Параметры правила настройте следующим образом:#
[loweralpha]
.. В поле `Название` введите "RuleForFileStreamStorage" или любое другое название.
.. В списке `Группа` выберите значение "ExternalFileStreamGroup".
.. В списке `Тип` оставьте значение "Все файлы" или конкретизируйте параметры файлов (см. рисунок ниже), которые будут размещаться в хранилище.
+
image::RuleForStorageInFileStream.png[Пример настройки правила для группы хранилищ "ExternalFileStreamGroup"]
. Повысьте приоритет использования правила "RuleForFileStreamStorage".
[loweralpha]
.. Выберите правило "RuleForFileStreamStorage" в списке правил.
.. Нажимайте на кнопку .image:Buttons/ArrowUp.png[image] пока правило "RuleForFileStreamStorage" не поднимется в верх списка.
+
image::StorageInFileStream.png[Пример настройки хранилища файлов в FileStream внешней БД]

При закрытии настроек БД согласитесь с перезапуском сервисов. Новая конфигурация файловых хранилищ применяется в течение 10 минут (по умолчанию).

